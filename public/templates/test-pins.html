<!DOCTYPE html>
<!-- 15 Oct 2012 dsmall Add analog inputs, Rascal 1.2 PCB, changes for bootstrap v2.1.1 -->
<html>
<head>
    <title>Test pins</title>
    {% include "include/rascal-head.html" %}
    <style>
        .well.pins {
            color: #F8F8F8;
            background-color: #333;
            border-color: #222;
        }
        .well.pins p.note {
            font-size: 0.8em;
            color: #AAA;
            margin: 3px 5px 5px;
        }
        th {
            font-size: 0.9em;
        }
        td {
            padding: 2px 6px;
        }
        img.led {
            opacity: 0.2;
            padding-bottom: 4px;
        }
        img.led.pcb {
            position: absolute;
            opacity: 0;
        }
        img.led.active {
            opacity: 1;
        }
        .progress.rascal {
            height: 10px;
            width: 250px;
            margin: 10px 0;
        }
        .progress .bar {
            /* Workaround for Chrome redraw issue when bar shrinks */
            /* -webkit-transform: translateZ(0.00001px); */
        }
    </style>
</head>
<body>
    {% include "include/rascal-topbar.html" %}
    <div class="container">
        <div class="well rascal">
            <h1>Test pins</h1>
            <p>View pin status, set pin direction and output status</p>
            <div class="row-fluid">
                <div class="span5">
                    <div class="well well-small pins">
                    <table>
                        <tr>
                            <th>
                            </th>
                            <th>
                            </th>
                            <th>Direction</th>
                            <th>Status</th>
                        </tr>
                        <tr>
                            <td>LED</td>
                            <td>
                                <img id="LED" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="LED" value="in" class="btn btn-primary" disabled="disabled">In</button>
                                    <button id="LED" value="out" class="btn btn-primary active" disabled="disabled">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="LED" value="off" class="btn btn-danger active">Off</button>
                                    <button id="LED" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 0</td>
                            <td>
                                <img id="0" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="0" value="in" class="btn btn-primary">In</button>
                                    <button id="0" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="0" value="off" class="btn btn-danger active">Off</button>
                                    <button id="0" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 1</td>
                            <td>
                                <img id="1" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="1" value="in" class="btn btn-primary">In</button>
                                    <button id="1" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="1" value="off" class="btn btn-danger active">Off</button>
                                    <button id="1" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 2</td>
                            <td>
                                <img id="2" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="2" value="in" class="btn btn-primary">In</button>
                                    <button id="2" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="2" value="off" class="btn btn-danger active">Off</button>
                                    <button id="2" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 3</td>
                            <td>
                                <img id="3" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="3" value="in" class="btn btn-primary">In</button>
                                    <button id="3" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="3" value="off" class="btn btn-danger active">Off</button>
                                    <button id="3" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 4</td>
                            <td>
                                <img id="4" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="4" value="in" class="btn btn-primary">In</button>
                                    <button id="4" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="4" value="off" class="btn btn-danger active">Off</button>
                                    <button id="4" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 5</td>
                            <td>
                                <img id="5" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="5" value="in" class="btn btn-primary">In</button>
                                    <button id="5" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="5" value="off" class="btn btn-danger active">Off</button>
                                    <button id="5" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 6</td>
                            <td>
                                <img id="6" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="6" value="in" class="btn btn-primary">In</button>
                                    <button id="6" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="6" value="off" class="btn btn-danger active">Off</button>
                                    <button id="6" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 7</td>
                            <td>
                                <img id="7" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="7" value="in" class="btn btn-primary">In</button>
                                    <button id="7" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="7" value="off" class="btn btn-danger active">Off</button>
                                    <button id="7" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 8</td>
                            <td>
                                <img id="8" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="8" value="in" class="btn btn-primary">In</button>
                                    <button id="8" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="8" value="off" class="btn btn-danger active">Off</button>
                                    <button id="8" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 9</td>
                            <td>
                                <img id="9" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="9" value="in" class="btn btn-primary">In</button>
                                    <button id="9" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="9" value="off" class="btn btn-danger active">Off</button>
                                    <button id="9" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 10</td>
                            <td>
                                <img id="10" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="10" value="in" class="btn btn-primary">In</button>
                                    <button id="10" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="10" value="off" class="btn btn-danger active">Off</button>
                                    <button id="10" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 11</td>
                            <td>
                                <img id="11" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="11" value="in" class="btn btn-primary">In</button>
                                    <button id="11" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="11" value="off" class="btn btn-danger active">Off</button>
                                    <button id="11" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 12</td>
                            <td>
                                <img id="12" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="12" value="in" class="btn btn-primary">In</button>
                                    <button id="12" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="12" value="off" class="btn btn-danger active">Off</button>
                                    <button id="12" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                        <tr>
                            <td>Pin 13</td>
                            <td>
                                <img id="13" src="static/images/led.gif" width="12" class="led" />
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="13" value="in" class="btn btn-primary">In</button>
                                    <button id="13" value="out" class="btn btn-primary active">Out</button>
                                </div>                  
                            </td>
                            <td>
                                <div class="btn-group" data-toggle="buttons-radio">
                                    <button id="13" value="off" class="btn btn-danger active">Off</button>
                                    <button id="13" value="on" class="btn btn-danger">On</button>
                                </div>                  
                            </td>
                        </tr>
                    </table>
                    <p class="note">Pins 0 &amp; 1 (serial) are not accessible from this page.
                        (Pins 6 &amp; 7 are used for I2C on older Rascals.)</p>
                    </div>
                    <div class="well well-small pins">
                    <table>
                        <tr>
                            <th></th>
                            <th>Analog Inputs</th>
                        </tr>
                        <tr>
                            <td>A0</td>
                            <td>
                                <div class="progress progress-danger rascal">
                                    <div id="A0" class="bar" style="width: 0%"></div>
                                </div> 
                            </td>
                        </tr>
                        <tr>
                            <td>A1</td>
                            <td>
                                <div class="progress progress-danger rascal">
                                    <div id="A1" class="bar" style="width: 0%"></div>
                                </div> 
                            </td>
                        </tr>
                        <tr>
                            <td>A2</td>
                            <td>
                                <div class="progress progress-danger rascal">
                                    <div id="A2" class="bar" style="width: 0%"></div>
                                </div> 
                            </td>
                        </tr>
                        <tr>
                            <td>A3</td>
                            <td>
                                <div class="progress progress-danger rascal">
                                    <div id="A3" class="bar" style="width: 0%"></div>
                                </div> 
                            </td>
                        </tr>
                    </table>
                    <p class="note">If readings are stuck at at full scale (all red),
                        check that the reference pin A/D REF is connected (no more than 3.3V).
                        Connect unused A/D inputs to GND.</p>
                    </div>
                </div> <!-- /span5 -->
                <div class="span7">
                    <div class="well well-small pins" style="position: relative;">
                        <img src="static/images/rascal-1.2-pcb.png" width="449" style="opacity: 0.7;" />
                        <img id="LED" src="static/images/led.gif" width="12" class="led pcb" style="top: 819px; left: 235px;" />
                        <img id="0" src="static/images/led.gif" width="12" class="led pcb" style="top: 795px; left: 378px;" />
                        <img id="1" src="static/images/led.gif" width="12" class="led pcb" style="top: 777px; left: 378px;" />
                        <img id="2" src="static/images/led.gif" width="12" class="led pcb" style="top: 759px; left: 378px;" />
                        <img id="3" src="static/images/led.gif" width="12" class="led pcb" style="top: 741px; left: 378px;" />
                        <img id="4" src="static/images/led.gif" width="12" class="led pcb" style="top: 723px; left: 378px;" />
                        <img id="5" src="static/images/led.gif" width="12" class="led pcb" style="top: 705px; left: 378px;" />
                        <img id="6" src="static/images/led.gif" width="12" class="led pcb" style="top: 687px; left: 378px;" />
                        <img id="7" src="static/images/led.gif" width="12" class="led pcb" style="top: 669px; left: 378px;" />
                        <img id="8" src="static/images/led.gif" width="12" class="led pcb" style="top: 641px; left: 378px;" />
                        <img id="9" src="static/images/led.gif" width="12" class="led pcb" style="top: 623px; left: 378px;" />
                        <img id="10" src="static/images/led.gif" width="12" class="led pcb" style="top: 605px; left: 378px;" />
                        <img id="11" src="static/images/led.gif" width="12" class="led pcb" style="top: 587px; left: 378px;" />
                        <img id="12" src="static/images/led.gif" width="12" class="led pcb" style="top: 569px; left: 378px;" />
                        <img id="13" src="static/images/led.gif" width="12" class="led pcb" style="top: 551px; left: 378px;" />
                    </div>
                </div>
            </div>
            <div id="cmd">&nbsp;</div>
           <div id="status">&nbsp;</div>
        </div>
    </div>
    <script type="text/javascript">

        $(":button").click( function() {
             // create URL like /pin/2/ON
            var cmd = "/pin/" + $(this).attr("id") + "/" + $(this).attr("value");
            $('#cmd')
                .stop(true)
                .text('Sent command: ' + cmd)
                .css('visibility', 'visible')
                .hide()
                .fadeTo(10, 1)
                .delay(2000)
                .fadeTo(1000, 0);
            $('#cmd').text('Sent command: ' + cmd);
            $.get(cmd, function (data, textStatus) {
                $('#status')
                    .stop(true)
                    .text('Rascal replied: ' + data)
                    .css('visibility', 'visible')
                    .hide()
                    .delay(500)
                    .fadeTo(10, 1)
                    .delay(1500)
                    .fadeTo(1000, 0);
            }).error(function (jqXHR, textStatus, errorThrown) {
                $('#status')
                    .stop(true)
                    .text('Rascal replied: ' + errorThrown)
                    .css('visibility', 'visible')
                    .hide()
                    .delay(500)
                    .fadeTo(10, 1)
            });
        });
        
        function read_pins() {
            
            $.post('/read-pins', function (response) {
                var data = JSON.parse(response);
                var pins, p, pin, btnIn, btnOut, btnOn, btnOff;

                // console.log(response);
                pins = data.pins;
                for (p in pins) {
                    pin = pins[p];
                    
                    // Set the LED
                    if (pin[1] === '1') {
                        $('.led[id="' + p + '"]').addClass('active');
                    } else {
                        $('.led[id="' + p + '"]').removeClass('active');
                    }
                    
                    // Update the buttons
                    btnIn = $('.btn[id="' + p + '"][value="in"]');
                    btnOut = $('.btn[id="' + p + '"][value="out"]');
                    btnOn = $('.btn[id="' + p + '"][value="on"]');
                    btnOff = $('.btn[id="' + p + '"][value="off"]');
                    
                    if (pin[0] === "out") {
                        if (btnIn.hasClass('active')) {
                            btnIn.removeClass('active');
                            btnOut.addClass('active');
                        }
                        if (btnOff.attr('disabled') === 'disabled') {
                            btnOff.removeAttr('disabled');
                            btnOn.removeAttr('disabled');
                        }
                    } else {
                        if (btnOut.hasClass('active')) {
                            btnOut.removeClass('active');
                            btnIn.addClass('active');
                        }
                        if (btnOff.attr('disabled') !== 'disabled') {
                            btnOff.attr('disabled', 'disabled');
                            btnOn.attr('disabled', 'disabled');
                        }
                    }                        
                    if (pin[1] === "1") {
                        // console.log('pin ' + p + ' ON');
                        if (btnOff.hasClass('active')) {
                            btnOff.removeClass('active');
                            btnOn.addClass('active');
                        }
                    } else {
                        // console.log('pin ' + p + ' OFF');
                        if (btnOn.hasClass('active')) {
                            btnOn.removeClass('active');
                            btnOff.addClass('active');
                        }
                    }
                }
                pins = data.analog;
                for (p in pins) {
                    pin = pins[p];
                    // console.log(p + '|' + pin);
                    // $('#' + p).css('width', Math.floor((pin * 100) / 1024) + '%');
                    $('#' + p).css('width', ((pin * 100) / 1024) + '%');
                }
            });
        }
        
        $(document).ready(function () {
            read_pins ();
            setInterval(read_pins, 1000);
        });

    </script>
</body>
</html>
